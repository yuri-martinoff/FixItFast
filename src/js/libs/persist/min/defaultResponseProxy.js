/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["./persistenceManager","./persistenceUtils","./fetchStrategies","./cacheStrategies","./persistenceStoreManager","./impl/defaultCacheHandler"],function(a,b,c,d,e,f){"use strict";function g(a){a=a||{},null==a.fetchStrategy&&(a.fetchStrategy=c.getCacheIfOfflineStrategy()),null==a.cacheStrategy&&(a.cacheStrategy=d.getHttpCacheHeaderStrategy()),a.requestHandlerOverride=a.requestHandlerOverride||{},null==a.requestHandlerOverride.handleGet&&(a.requestHandlerOverride.handleGet=this.handleGet),null==a.requestHandlerOverride.handlePost&&(a.requestHandlerOverride.handlePost=this.handlePost),null==a.requestHandlerOverride.handlePut&&(a.requestHandlerOverride.handlePut=this.handlePut),null==a.requestHandlerOverride.handlePatch&&(a.requestHandlerOverride.handlePatch=this.handlePatch),null==a.requestHandlerOverride.handleDelete&&(a.requestHandlerOverride.handleDelete=this.handleDelete),null==a.requestHandlerOverride.handleHead&&(a.requestHandlerOverride.handleHead=this.handleHead),null==a.requestHandlerOverride.handleOptions&&(a.requestHandlerOverride.handleOptions=this.handleOptions),Object.defineProperty(this,"_options",{value:a})}function h(a){return new g(a)}function i(a,b){var c=a,d=c._options,e=null;return"POST"===b.method?e=d.requestHandlerOverride.handlePost:"GET"===b.method?e=d.requestHandlerOverride.handleGet:"PUT"===b.method?e=d.requestHandlerOverride.handlePut:"PATCH"===b.method?e=d.requestHandlerOverride.handlePatch:"DELETE"===b.method?e=d.requestHandlerOverride.handleDelete:"HEAD"===b.method?e=d.requestHandlerOverride.handleHead:"OPTIONS"===b.method&&(e=d.requestHandlerOverride.handleOptions),e}function j(b){if(a.isOnline())return a.browserFetch(b);var c={status:503,statusText:"Must provide handlePost override for offline"};return Promise.resolve(new Response(null,c))}function k(a,b){var c=a,d=c._options.fetchStrategy;return new Promise(function(a,e){d(b,c._options).then(function(b){a(b)}).catch(function(a){e(a)})})}function l(b,c){var d=b;return a.isOnline()?new Promise(function(b,e){a.browserFetch(c.clone()).then(function(a){if(!a.ok)return p(d,c,a,m);b(a)},function(a){return m(d,c)}).then(function(a){a&&b(a)}).catch(function(a){e(a)})}):m(d,c)}function m(a,c){return new Promise(function(a,d){b.requestToJSON(c).then(function(c){c.status=200,c.statusText="OK",c.headers["content-type"]="application/json",c.headers["x-oracle-jscpt-cache-expiration-date"]="";var d=c.headers["if-match"],e=c.headers["if-none-match"];if(d||e){var f=Math.floor(1e6*Math.random());c.headers.etag=(Date.now()+f).toString(),c.headers["x-oracle-jscpt-etag-generated"]=c.headers.etag,delete c.headers["if-match"],delete c.headers["if-none-match"]}b.responseFromJSON(c).then(function(b){a(b)})})})}function n(b,c){var d=b;return a.isOnline()?new Promise(function(b,e){a.browserFetch(c.clone()).then(function(a){if(!a.ok)return p(d,c,a,o);b(a)},function(a){return o(d,c)}).then(function(a){a&&b(a)}).catch(function(a){e(a)})}):o(d,c)}function o(a,c){var d=a;return new Promise(function(a,f){b.requestToJSON(c).then(function(f){f.status=200,f.statusText="OK",f.headers["content-type"]="application/json",f.headers["x-oracle-jscpt-cache-expiration-date"]="",b.responseFromJSON(f).then(function(g){var h=q(c),i=null;d._options&&d._options.jsonProcessor&&d._options.jsonProcessor.shredder&&(i=d._options.jsonProcessor.shredder),i?i(g).then(function(c){if(c){var d=c[0].name;e.openStore(d).then(function(c){c.findByKey(h).then(function(c){c&&b.responseFromJSON(f).then(function(d){b.setResponsePayload(d,c).then(function(b){a(b)})})})})}}):a(g)})})})}function p(a,b,c,d){var e=a;return new Promise(function(a,f){c.status<500?a(c):d(e,b).then(function(b){a(b)},function(a){f(a)})})}function q(a){var b=a.url.split("/");return b[b.length-1]}function r(a,b,c){var d=a;if("GET"===b.method||"HEAD"===b.method){return(0,d._options.cacheStrategy)(b,c,d._options)}return Promise.resolve(c)}function s(b,c,d){return!a.isOnline()||d?a.getSyncManager().insertRequest(b,{undoRedoDataArray:c}):Promise.resolve()}function t(b,c){return new Promise(function(d,e){"GET"==b.method||"HEAD"==b.method?a.getCache().hasMatch(b,{ignoreSearch:!0}).then(function(a){a?u(b,c).then(function(a){d(a)},function(a){e(a)}):d()}):u(b,c).then(function(a){d(a)},function(a){e(a)})})}function u(a,b){return new Promise(function(c,d){f.constructShreddedData(a,b).then(function(b){return b?v(a,b):Promise.resolve()}).then(function(a){c(a)}).catch(function(a){d(a)})})}function v(a,b){var c=[];return b.forEach(function(b){var d=Object.keys(b)[0];c.push(w(a,d,b[d]))}),Promise.all(c)}function w(a,b,c){return new Promise(function(d,e){x(a,b,c).then(function(d){return"DELETE"===a.method?z(b,c,d):y(b,c,d)}).then(function(a){d(a)}).catch(function(a){e(a)})})}function x(a,b,c){return new Promise(function(d,f){var g,h,i=[],j=function(c,f){c<f.length&&"GET"!==a.method&&"HEAD"!==a.method?(g=f[c].key.toString(),h="DELETE"!==a.method?f[c].value:null,e.openStore(b).then(function(a){a.findByKey(g).then(function(a){i.push({key:g,undo:a,redo:h}),j(++c,f)},function(a){i.push({key:g,undo:null,redo:h}),j(++c,f)})})):d(i)};j(0,c)})}function y(a,b,c){return new Promise(function(d,f){e.openStore(a).then(function(a){return a.upsertAll(b)}).then(function(){c.length>0?d({storeName:a,operation:"upsert",undoRedoData:c}):d()}).catch(function(a){f(a)})})}function z(a,b,c){return new Promise(function(d,f){e.openStore(a).then(function(a){return a.removeByKey(b[0].key)}).then(function(){c.length>0?d({storeName:a,operation:"remove",undoRedoData:c}):d()}).catch(function(a){f(a)})})}return g.prototype.getFetchEventListener=function(){var a=this;return function(b){b.respondWith(new Promise(function(c,d){a.processRequest(b.request).then(function(a){c(a)},function(a){d(a)}).catch(function(a){d(a)})}))}},g.prototype.processRequest=function(a){var c=this,d=b.buildEndpointKey(a);return new Promise(function(e,g){f.registerEndpointOptions(d,c._options);var h=i(c,a),j={},k=a.clone();h.call(c,a).then(function(d){return b.isCachedResponse(d)&&(j.isCachedResponse=!0),d.ok?r(c,a,d):Promise.resolve(d)}).then(function(b){return j.response=b,b.ok?t(a,b):Promise.resolve(null)}).then(function(b){return s(a,b,j.isCachedResponse)}).then(function(){f.unregisterEndpointOptions(d),e(j.response)}).catch(function(a){s(k,null,!0).then(function(){f.unregisterEndpointOptions(d),g(a)},function(){f.unregisterEndpointOptions(d),g(a)})})})},g.prototype.handlePost=function(a){return j(a)},g.prototype.handleGet=function(a){return k(this,a)},g.prototype.handleHead=function(a){return k(this,a)},g.prototype.handleOptions=function(a){return j(a)},g.prototype.handlePut=function(a){return l(this,a)},g.prototype.handlePatch=function(a){return j(a)},g.prototype.handleDelete=function(a){return n(this,a)},{getResponseProxy:h}});
//# sourceMappingURL=defaultResponseProxy.js.map