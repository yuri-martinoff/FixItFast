/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["../PersistenceStore","pouchdb","pouchfind"],function(a,b){"use strict";var c=function(b){a.call(this,b)};c.prototype=new a,c.prototype.Init=function(a){this._version=a&&a.version||"0";var c=this._name+this._version;if(this._db=new b(c),a&&a.index){var d=this,e=a.index,f=d._name+e.toString().replace(",","").replace(".",""),g={index:{fields:e,name:f}};return new Promise(function(a,b){d._db.createIndex(g).then(function(){a()}).catch(function(a){b(a)})})}return Promise.resolve()},c.prototype.upsert=function(a,b,c,e){var f=this,g=a.toString(),h=[];return this._prepareUpsert(c,h),new Promise(function(a,i){f._db.get(g).then(function(a){return d(e,a)?Promise.resolve(a):Promise.reject({status:409})}).catch(function(a){return 404===a.status&&"missing"===a.message?Promise.resolve():Promise.reject(a)}).then(function(a){return f._put(g,b,c,e,h,a)}).then(function(){a()}).catch(function(a){i(a)})})},c.prototype._put=function(a,b,c,e,f,g){var h={_id:a,metadata:b,value:c};g&&(h._rev=g._rev);var i=this;return new Promise(function(b,c){i._db.put(h).then(function(a){return Promise.resolve(a)}).catch(function(b){if(409!==b.status)return Promise.reject(b);i._db.get(a).then(function(a){return e?d(e,a)?Promise.resolve(a):Promise.reject({status:409}):Promise.resolve(a)})}).then(function(a){return i._addAttachments(a,f)}).then(function(){b()}).catch(function(a){c(a)})})};var d=function(a,b){if(a){return b.metadata.versionIdentifier===a}return!0};return c.prototype._addAttachments=function(a,b){if(b&&b.length){var c=b.map(function(b){var c;return c=b.value instanceof Blob?b.value:new Blob([b.value]),this._db.putAttachment(a.id,b.path,a.rev,c,"binary")},this);return Promise.all(c)}return Promise.resolve()},c.prototype.upsertAll=function(a){if(a&&a.length){var b=a.map(function(a){return this.upsert(a.key,a.metadata,a.value,a.expectedVersionIdentifier)},this);return Promise.all(b)}return Promise.resolve()},c.prototype.find=function(a){var b=this,c=b._prepareFind(a);return new Promise(function(a,d){b._db.find(c).then(function(a){if(a&&a.docs&&a.docs.length){var d=a.docs.map(b._findResultCallback(c.fields),b);return Promise.all(d)}return Promise.resolve([])}).catch(function(a){return 404===a.status&&"missing"===a.message?Promise.resolve([]):Promise.reject(a)}).then(function(b){a(b)}).catch(function(a){d(a)})})},c.prototype._findResultCallback=function(a){return function(b){var c=this;return new Promise(function(d,e){c._fixValue(b).then(function(b){d(a?b:b.value)}).catch(function(a){e(a)})})}},c.prototype._fixValue=function(a){var b=a._id||a.id||a.key;b&&(a.key=b);var c=a._attachments;if(c){var d=this,e=Object.keys(c)[0];return new Promise(function(c,f){d._db.getAttachment(b,e).then(function(b){for(var d=e.split("."),f=a.value,g=0;g<d.length-1;g++)f=f[d[g]];f[d[d.length-1]]=b,c(a)}).catch(function(a){f(a)})})}return Promise.resolve(a)},c.prototype.findByKey=function(a){var b=this,c=a.toString();return new Promise(function(a,d){b._db.get(c).then(function(b){a(b.value)}).catch(function(b){404===b.status&&"missing"===b.message?a():d(b)})})},c.prototype.removeByKey=function(a){var b=this,c=a.toString();return new Promise(function(a,d){b._db.get(c).then(function(a){return b._db.remove(a)}).then(function(){a(!0)}).catch(function(b){404===b.status&&"missing"===b.message?a(!1):d(b)})})},c.prototype.delete=function(a){var b=this;if(a){var c=a;return c.fields=["_id","_rev"],new Promise(function(a,d){b.find(c).then(function(c){if(c&&c.length){var d=c.map(function(a){return this._db.remove(a._id,a._rev)},b);return Promise.all(d)}a()}).then(function(){a()}).catch(function(a){d(a)})})}return new Promise(function(a,c){b._db.allDocs({include_docs:!0}).then(function(a){if(a&&a.rows&&a.rows.length){var c=a.rows.map(function(a){this._db.remove(a.doc)},b);return Promise.all(c)}return Promise.resolve()}).then(function(){a()}).catch(function(a){c(a)})})},c.prototype.keys=function(){var a=this;return new Promise(function(b,c){a._db.allDocs().then(function(a){var c=a.rows,d=[];c&&c.length&&(d=c.map(function(a){return a.id})),b(d)}).catch(function(a){c(a)})})},c.prototype._prepareFind=function(a){var b=a||{};void 0!==b.sort&&delete b.sort,b.selector||(b.selector={_id:{$gt:null}});var c=b.fields;if(c&&c.length){var d=c.map(function(a){return"key"===a?"_id":a});b.fields=d}return b},c.prototype._prepareUpsert=function(a,b){this._inspectValue("",a,b)},c.prototype._inspectValue=function(a,b,c){for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if(e&&"object"==typeof e)if(e instanceof Blob||e instanceof ArrayBuffer){var f=a;f.length>0&&(f+=".");var g={path:f+d,value:e};c.push(g),b.key=null}else if(void 0===e.length){var h=a;a.length>0&&(a+="."),a+=d,this._inspectValue(a,e,c),a=h}}},c});
//# sourceMappingURL=pouchDBPersistenceStore.js.map