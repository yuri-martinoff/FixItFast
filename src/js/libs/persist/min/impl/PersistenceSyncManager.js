/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["require","../persistenceUtils","../persistenceStoreManager","./defaultCacheHandler","./logger"],function(a,b,c,d,e){"use strict";function f(a,b,c){Object.defineProperty(this,"_eventListeners",{value:[],writable:!0}),Object.defineProperty(this,"_isOnline",{value:a}),Object.defineProperty(this,"_browserFetch",{value:b}),Object.defineProperty(this,"_cache",{value:c})}function g(a){var b=a;return new Promise(function(a,c){l().then(function(a){return m(a)}).then(function(c){b._readingSyncLog=null,a(c)}).catch(function(a){c(a)})})}function h(a,b){var c=a,d=c._options.preflightOptionsRequest,e=c._options.preflightOptionsRequestTimeout;if(null!=b.url&&"disabled"!=d&&null!=b.url.match(d)){if(c._pingedURLs){if(c._pingedURLs.indexOf(b.url)>=0)return Promise.resolve(!0)}else c._pingedURLs=[];return c._preflightOptionsRequestId=(new Date).getTime(),new Promise(function(a){return function(d,f){c._repliedOptionsRequest=!1;var g=new Request(b.url,{method:"OPTIONS"}),h=6e4;null!=e&&(h=e),setTimeout(function(){c._repliedOptionsRequest||c._preflightOptionsRequestId!=a||f(!1)},h),c._browserFetch(g).then(function(a){c._repliedOptionsRequest=!0,c._pingedURLs||(c._pingedURLs=[]),c._pingedURLs.push(b.url),d(!0)},function(a){c._repliedOptionsRequest=!0,d(!0)})}}(c._preflightOptionsRequestId))}return Promise.resolve(!0)}function i(a){return a=a||{},"stop"===a.action}function j(a){if(a&&a.length>0){var b,c,d=[];for(b=0;b<a.length;b++)c=a[b].request,"GET"!=c.method&&"HEAD"!=c.method&&d.push(a[b]);for(b=0;b<a.length;b++)c=a[b].request,"GET"!=c.method&&"HEAD"!=c.method||d.push(a[b]);return d}return a}function k(a,b){return{requestId:a,request:b,undo:function(){return q(a)},redo:function(){return p(a)}}}function l(){return new Promise(function(a,b){w().then(function(a){return a.find(o())}).then(function(b){a(b)}).catch(function(a){b(a)})})}function m(a){return new Promise(function(c,d){var e,f,g=[],h=function(a){a&&0!=a.length?(e=a[0].metadata.created.toString(),f=a[0].value,b.requestFromJSON(f).then(function(b){g.push(k(e,b)),a.shift(),h(a)},function(a){d(a)})):c(g)};h(a)})}function n(a,b){var c=a;return new Promise(function(a,d){c.getSyncLog().then(function(c){var d,e,f=c.length;for(d=0;d<f;d++)if(c[d].requestId===b){e=c[d].request,a(e);break}},function(a){d(a)})})}function o(){var a={},b=[],c=[];c.push("metadata.created"),a.sort=c,b.push("metadata.created"),b.push("value"),a.fields=b;var d={},e={};return e.$exists=!0,d["metadata.created"]=e,a.selector=d,a}function p(a){return new Promise(function(b,c){x().then(function(b){return b.findByKey(a)}).then(function(a){null!=a?r(a,!1).then(function(){b(!0)}):b(!1)}).catch(function(a){c(a)})})}function q(a){return new Promise(function(b,c){x().then(function(b){return b.findByKey(a)}).then(function(a){null!=a?r(a,!0).then(function(){b(!0)}):b(!1)}).catch(function(a){c(a)})})}function r(a,b){return new Promise(function(d,e){var f,g,h,i,j,k=[],l=a.length,m=function(e){if(e<l)if(h=a[e].storeName,"upsert"==(g=a[e].operation)){for(i=a[e].undoRedoData,k=[],j=i.length,f=0;f<j;f++)b?k.push({key:i[f].key,value:i[f].undo}):k.push({key:i[f].key,value:i[f].redo});c.openStore(h).then(function(a){a.upsertAll(k).then(function(){m(++e)})})}else"remove"==g&&c.openStore(h).then(function(a){a.removeByKey(i[0].key).then(function(){m(++e)})});else d()};m(0)})}function s(a,b,c,d){return u(c,a._eventListeners.filter(t(b,d)))}function t(a,b){return function(c){return a.toLowerCase()==c.type&&(null!=b&&b.match(c.scope)||null==b||null==c.scope)}}function u(a,b){return b.length>0?b[0].listener(a).then(function(a){return null!=a?Promise.resolve(a):b.length>1?u(b.slice(1)):void 0}):Promise.resolve(null)}function v(a){return new Promise(function(b,d){var e={index:["metadata.created"]};c.openStore(a,e).then(function(a){b(a)}).catch(function(a){d(a)})})}function w(){return v("syncLog")}function x(){return v("redoUndoLog")}return f.prototype.addEventListener=function(a,b,c){this._eventListeners.push({type:a.toLowerCase(),listener:b,scope:c})},f.prototype.removeEventListener=function(a,b,c){this._eventListeners=this._eventListeners.filter(function(d){return a.toLowerCase()!=d.type||b!=d.listener||c!=d.scope})},f.prototype.getSyncLog=function(){return this._readingSyncLog||(this._readingSyncLog=g(this)),this._readingSyncLog},f.prototype.insertRequest=function(a,c){return new Promise(function(e,f){var g={};w().then(function(c){return g.store=c,b.requestToJSON(a,{_noClone:!0})}).then(function(b){return g.requestData=b,g.metadata=d.constructMetadata(a),g.requestId=g.metadata.created.toString(),g.store.upsert(g.requestId,g.metadata,g.requestData)}).then(function(){if(null!=c){var a=c.undoRedoDataArray;null!=a?x().then(function(b){var c=function(d){d<a.length&&null!=a[d]?b.upsert(g.requestId,g.metadata,a[d]).then(function(){c(++d)}):e()};c(0)}):e()}else e()}).catch(function(a){f(a)})})},f.prototype.removeRequest=function(a){var b=this;return new Promise(function(c,d){var e={};w().then(function(c){return e.store=c,n(b,a)}).then(function(b){return e.request=b,e.store.removeByKey(a)}).then(function(){return x()}).then(function(b){return b.removeByKey(a)}).then(function(){c(e.request)}).catch(function(a){d(a)})})},f.prototype.updateRequest=function(a,c){return Promise.all([w(),b.requestToJSON(c)]).then(function(b){var e=b[0],f=b[1],g=d.constructMetadata(c);return e.upsert(a,g,f)})},f.prototype.sync=function(a){this._options=a||{};var c=this;if(this._syncing)return Promise.reject("Cannot start sync while sync is in progress");this._syncing=!0;var d=new Promise(function(a,d){c.getSyncLog().then(function(f){if(c._isOnline()){var g,k,l,m,n=function(f){0==f.length&&a(),f.length>0&&(g=f[0].requestId,k=f[0].request,l=k.clone(),s(c,"beforeSyncRequest",{requestId:g,request:l.clone()},k.url).then(function(j){if(i(j))return void a();j=j||{},"skip"!==j.action?("replay"===j.action&&(k=j.request),l=k.clone(),h(c,k).then(function(){c._browserFetch(k).then(function(h){if((m=h.status)>=400)return void d({error:h.statusText,requestId:g,request:l.clone(),response:h.clone()});b._cloneResponse(h).then(function(h){s(c,"syncRequest",{requestId:g,request:l.clone(),response:h.clone()},k.url).then(function(j){i(j)?a():c.removeRequest(g).then(function(){f.shift(),"GET"==k.method||"HEAD"==k.method?b._cloneResponse(h).then(function(a){c._cache().put(k,a).then(function(){e.log("replayed request/response is cached."),n(f)})}):n(f)},function(a){d({error:a,requestId:g,request:l.clone()})})})})},function(a){d({error:a,requestId:g,request:l.clone()})})},function(a){if(!1===a){var b={status:504,statusText:"Preflight OPTIONS request timed out"};d({error:"Preflight OPTIONS request timed out",requestId:g,request:l.clone(),response:new Response(null,b)})}else d({error:a,requestId:g,request:l.clone()})})):c.removeRequest(g).then(function(){f.shift(),n(f)},function(a){d({error:a,requestId:g,request:l.clone()})})}))};f=j(f),n(f)}else a()},function(a){d(a)})});return new Promise(function(a,b){d.then(function(b){c._syncing=!1,c._pingedURLs=null,a(b)},function(a){c._syncing=!1,c._pingedURLs=null,b(a)})})},f});
//# sourceMappingURL=PersistenceSyncManager.js.map