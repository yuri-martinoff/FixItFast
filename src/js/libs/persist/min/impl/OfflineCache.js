/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["./defaultCacheHandler"],function(a){"use strict";function b(a,b){if(!a)throw TypeError("A name must be provided to create an OfflineCache!");if(!b)throw TypeError("A persistence store must be provided to create an OfflineCache!");this._name=a,this._store=b}function c(a,b,c){if(c&&c.length)for(var d=0;d<c.length;d++){var e=c[d];if(f(a,b,e))return e.responseData}return null}function d(a,b,c){var d=[];if(c&&c.length){d=c.filter(e(a,b)).map(function(a){return a.responseData})}return d}function e(a,b,c){return function(d){var e;return e=c?d[c]:d,f(a,b,e)}}function f(a,b,c){if(a)return!0;if(!c||!b)return!1;var d=c.requestData.headers,e=c.responseData.headers,f=b.headers,g=e.vary;if(!g)return!0;if("*"===g.trim())return!1;for(var h=g.split(","),i=0;i<h.length;i++){var j=h[i].toLowerCase(),k=f.get(j),l=d[j];if(!(!l&&!k||l&&k&&l===k))return!1}return!0}function g(b){if(b){var c=[],d=b.bodyAbstract;return d?(c.push(Promise.resolve(JSON.parse(d))),delete b.bodyAbstract):c.push(Promise.resolve()),c.push(a.constructResponse(b)),Promise.all(c)}return Promise.resolve()}function h(a){if(a&&a.length){var b=a.map(function(a){return g(a)});return Promise.all(b)}return Promise.resolve()}function i(a){var b=a.map(function(a){return{name:a.name,keys:a.keys,resourceType:a.resourceType}});return JSON.stringify(b)}return b.prototype.getName=function(){return this._name},b.prototype.add=function(a){var b=this;return fetch(a).then(function(c){var d=c.clone();return b.put(a,c).then(function(){Promise.resolve(d)})})},b.prototype.addAll=function(a){var b=a.map(this.add,this);return Promise.all(b)},b.prototype.match=function(b,d){var e=this,f=a.constructSearchCriteria(b,d),h=d&&d.ignoreVary;return e._store.find(f).then(function(a){return g(c(h,b,a))}).then(function(c){if(c){var d=c[0],e=c[1];return a.fillResponseBodyWithShreddedData(b,d,e)}return Promise.resolve()})},b.prototype.matchAll=function(b,c){var e=this,f=a.constructSearchCriteria(b,c),g=c&&c.ignoreVary;return e._store.find(f).then(function(a){return h(d(g,b,a))}).then(function(c){if(c&&c.length){var d=c.map(function(c){var d=c[0],e=c[1];return a.fillResponseBodyWithShreddedData(b,d,e)});return Promise.all(d)}return Promise.resolve([])})},b.prototype.put=function(b,c){var d=this,e=[];return e.push(a.constructRequestResponseCacheData(b,c)),e.push(a.shredResponse(b,c)),Promise.all(e).then(function(b){var c=b[0],e=b[1];if(e){var f=[];return c.value.responseData.bodyAbstract=i(e),f.push(d._store.upsert(c.key,c.metadata,c.value)),f.push(a.cacheShreddedData(e)),Promise.all(f)}return d._store.upsert(c.key,c.metadata,c.value)})},b.prototype.delete=function(a,b){var c=this;return new Promise(function(d,e){c.keys(a,b).then(function(a){if(a&&a.length){var b=a.map(c._store.removeByKey,c._store);return Promise.all(b)}return Promise.resolve(!1)}).then(function(a){d(a&&a.length?!0:!1)}).catch(function(a){e(a)})})},b.prototype.keys=function(b,c){var d=this;if(b){var f=a.constructSearchCriteria(b,c);f.fields=["key","value"];var g=c&&c.ignoreVary;return new Promise(function(a,c){d._store.find(f).then(function(c){if(c&&c.length){var d=c.filter(e(g,b,"value")),f=d.map(function(a){return a.key});a(f)}else a([])}).catch(function(a){c(a)})})}return new Promise(function(a,b){d._store.keys().then(function(b){a(b)}).catch(function(a){b(a)})})},b.prototype.hasMatch=function(b,d){var e=this,f=a.constructSearchCriteria(b,d),g=d&&d.ignoreVary;return new Promise(function(a,d){e._store.find(f).then(function(d){var e=c(g,b,d);a(null!==e)}).catch(function(a){d(a)})})},b});
//# sourceMappingURL=OfflineCache.js.map