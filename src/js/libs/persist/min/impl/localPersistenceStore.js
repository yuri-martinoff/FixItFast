/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["../PersistenceStore"],function(a){"use strict";var b=function(b){a.call(this,b)};return b.prototype=new a,b.prototype.Init=function(a){return this._version=a&&a.version||"0",Promise.resolve()},b.prototype.upsert=function(a,b,c,d){var e=this.createRawKey(a),f=localStorage.getItem(e);if(f&&d){var g=JSON.parse(f).metadata.versionIdentifier;if(g!==d)return Promise.reject({status:409});return b.versionIdentifier!==g&&this._insert(e,b,c),Promise.resolve()}return this._insert(e,b,c),Promise.resolve()},b.prototype._insert=function(a,b,c){var d={metadata:b,value:c},e=JSON.stringify(d);localStorage.setItem(a,e)},b.prototype.upsertAll=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];b.push(this.upsert(d.key,d.metadata,d.value,d.expectedVersionIndentifier))}return Promise.all(b)},b.prototype.find=function(a){for(var b=this,c=[],d=[],a=a||{},e=Object.keys(localStorage),f=0;f<e.length;f++){var g=e[f],h=this.extractKey(g);if(h){var i=JSON.parse(localStorage.getItem(g));b._satisfy(a.selector,i)&&(i.key=h,d.push(i))}}for(var j=this._sort(d,a.sort),f=0;f<j.length;f++)c.push(b._constructReturnObject(a.fields,j[f]));return Promise.resolve(c)},b.prototype._sort=function(a,b){return a&&a.length&&b&&b.length?a.sort(this._sortFunction(b,this)):a},b.prototype._sortFunction=function(a,b){return function(c,d){for(var e=0;e<a.length;e++){var f,g=a[e],h=!0;if("string"==typeof g)f=g;else{if("object"!=typeof g)throw new Error("invalid sort criteria.");var i=Object.keys(g);if(!i||1!==i.length)throw new Error("invalid sort criteria");f=i[0],h="asc"===g[f].toLowerCase()}var j=b._getValue(f,c),k=b._getValue(f,d);if(j!=k)return h?j<k?-1:1:j<k?1:-1}return 0}},b.prototype.findByKey=function(a){var b=this.createRawKey(a),c=localStorage.getItem(b);return c?Promise.resolve(JSON.parse(c).value):Promise.resolve()},b.prototype.removeByKey=function(a){var b=this.createRawKey(a);return localStorage.getItem(b)?(localStorage.removeItem(b),Promise.resolve(!0)):Promise.resolve(!1)},b.prototype.createRawKey=function(a){return this._name+this._version+a.toString()},b.prototype.extractKey=function(a){var b=this._name+this._version,c=b.length;return 0===a.indexOf(b)?a.slice(c):null},b.prototype._satisfy=function(a,b){if(a){var c=this._buildExpressionTree(a);return this._evaluateExpressionTree(c,b)}return!0},b.prototype._buildExpressionTree=function(a){var b,c=[];for(var d in a)if(a.hasOwnProperty(d)){var e=a[d];if(0===d.indexOf("$")){if(this._isMultiSelector(d)){if(!(e instanceof Array))throw new Error("not a valid expression: "+a);b={operator:d,array:[]};for(var f=0;f<e.length;f++){var g=this._buildExpressionTree(e[f]);b.array.push(g)}}else if(this._isSingleSelector(d))throw new Error("not a valid expression: "+a)}else if(this._isLiteral(e))c.push({left:d,right:e,operator:"$eq"});else{var h={left:d};this._completePartialTree(h,e),c.push(h)}}return c.length>1?b={operator:"$and",array:c}:1===c.length&&(b=c[0]),b},b.prototype._completePartialTree=function(a,b){var c=!1;for(var d in b)if(b.hasOwnProperty(d)){var e=b[d];if(c||!this._isSingleSelector(d))throw new Error("parsing error "+b);a.operator=d,a.right=e,c=!0}},b.prototype._evaluateExpressionTree=function(a,b){var c=a.operator;if(this._isMultiSelector(c)){if(!a.left&&a.array instanceof Array){for(var d,e=a.array,f=0;f<e.length;f++){var g=this._evaluateExpressionTree(e[f],b);if("$or"===c&&!0===g)return!0;if("$and"===c&&!1===g)return!1;d=g}return d}throw new Error("invalid expression tree!"+a)}if(this._isSingleSelector(c)){var h=this._getValue(a.left,b),i=a.right;if("$lt"===c)return h<i;if("$gt"===c)return h>i;if("$lte"===c)return h<=i;if("$gte"===c)return h>=i;if("$eq"===c)return h===i;if("$ne"===c)return h!==i;if("$regex"===c){return null!==h.match(i)}if("$exists"===c)return i?null!==h&&void 0!==h:null===h||void 0===h;throw new Error("not a valid expression! "+a)}throw new Error("not a valid expression!"+a)},b.prototype._isMultiSelector=function(a){return"$and"===a||"$or"===a},b.prototype._isSingleSelector=function(a){return"$lt"===a||"$gt"===a||"$lte"===a||"$gte"===a||"$eq"===a||"$ne"===a||"$regex"===a||"$exists"===a},b.prototype._isLiteral=function(a){return"object"!=typeof a},b.prototype._getValue=function(a,b){for(var c=a.split("."),d=b,e=0;e<c.length;e++)d=d[c[e]];return d},b.prototype._constructReturnObject=function(a,b){var c;if(a){c={};for(var d=0;d<a.length;d++)for(var e=c,f=b,g=a[d],h=g.split("."),i=0;i<h.length;i++)f=f[h[i]],!e[h[i]]&&i<h.length-1&&(e[h[i]]={}),i===h.length-1?e[h[i]]=f:e=e[h[i]]}else c=b.value;return c},b.prototype.delete=function(a){var b=this;if(!a){for(var c=Object.keys(localStorage),d=0;d<c.length;d++){this.extractKey(c[d])&&localStorage.removeItem(c[d])}return Promise.resolve()}return new Promise(function(c,d){var e=a;e.fields=["key"],b.find(e).then(function(a){if(a&&a.length){var c=a.map(b._removeByKeyMapCallback("key"),b);return Promise.all(c)}return Promise.resolve()}).then(function(){c()}).catch(function(a){d(a)})})},b.prototype._removeByKeyMapCallback=function(a){var b=this;return function(c){var d;return d=a?c[a]:c,b.removeByKey(d)}},b.prototype.keys=function(){for(var a=Object.keys(localStorage),b=[],c=0;c<a.length;c++){var d=this.extractKey(a[c]);d&&b.push(d)}return Promise.resolve(b)},b});
//# sourceMappingURL=localPersistenceStore.js.map