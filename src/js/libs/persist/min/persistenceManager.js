/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["./impl/PersistenceXMLHttpRequest","./impl/PersistenceSyncManager","./impl/offlineCacheManager","./impl/fetch"],function(a,b,c){"use strict";function d(){Object.defineProperty(this,"_registrations",{value:[],writable:!0}),Object.defineProperty(this,"_eventListeners",{value:[],writable:!0}),Object.defineProperty(this,"_forceOffline",{value:!1,writable:!0}),Object.defineProperty(this,"_isOffline",{value:!1,writable:!0}),Object.defineProperty(this,"_cache",{value:null,writable:!0}),Object.defineProperty(this,"_persistenceSyncManager",{value:new b(this.isOnline.bind(this),this.browserFetch.bind(this),this.getCache.bind(this))})}function e(a){var b=a;f()&&!b._addedBrowserEventListeners&&(window.addEventListener("offline",function(a){b._isOffline=!0},!1),window.addEventListener("online",function(a){b._isOffline=!1},!1),b._addedBrowserEventListeners=!0)}function f(){return"undefined"!=typeof window&&null!=window}function g(a,b,c){var d,e,f,g,h=null,i=a._registrations,j=null!=i?i.length:0;for(d=0;d<j;d++)if(f=i[d],null!=c.request.url.match(f.scope)){for(g=f._eventListeners.length,e=0;e<g;e++)if(f._eventListeners[e].type==b)if("fetch"==b)null===h&&c._setPromiseCallbacks instanceof Function&&(h=new Promise(function(a,b){c._setPromiseCallbacks(a,b)})),f._eventListeners[e].listener(c);else if(!1===f._eventListeners[e].listener(c))return!1;if(null!=h)return h}return!0}function h(a){var b=a;return new Promise(function(a,d){c.open("systemCache").then(function(c){b._cache=c,a()},function(a){d(a)})})}function i(b){var c=b;!f()||c._browserFetchFunc||c._browserXMLHttpRequest||(Object.defineProperty(c,"_browserFetchFunc",{value:window.fetch,writable:!1}),Object.defineProperty(c,"_browserXMLHttpRequest",{value:window.XMLHttpRequest,writable:!1}),window.fetch=l(b),window.XMLHttpRequest=function(){return null!=c._browserFetchRequest?new c._browserXMLHttpRequest:new a(c._browserXMLHttpRequest)})}function j(a,b){var c=a,d=c._registrations.indexOf(b);return d>-1&&(c._registrations.splice(d,1),!0)}function k(a,b){Object.defineProperty(this,"scope",{value:a,enumerable:!0}),Object.defineProperty(this,"_persistenceManager",{value:b}),Object.defineProperty(this,"_eventListeners",{value:[],writable:!0})}function l(a){function b(a){Object.defineProperty(this,"isReload",{value:!1,enumerable:!0}),Object.defineProperty(this,"clientId",{value:null,enumerable:!0}),Object.defineProperty(this,"client",{value:null,enumerable:!0}),Object.defineProperty(this,"request",{value:a,enumerable:!0}),Object.defineProperty(this,"_resolveCallback",{value:null,writable:!0}),Object.defineProperty(this,"_rejectCallback",{value:null,writable:!0})}return b.prototype.respondWith=function(a){var b=this;if(a instanceof Promise)a.then(function(a){b._resolveCallback(a)},function(a){b._rejectCallback(a)});else if("function"==typeof a){var c=a();b._resolveCallback(c)}},b.prototype._setPromiseCallbacks=function(a,b){this._resolveCallback=a,this._rejectCallback=b},function(c,d){return new Promise(function(e,f){var h;h=Request.prototype.isPrototypeOf(c)&&!d?c:new Request(c,d),a.getRegistration(h.url).then(function(c){if(null!=c){var d=new b(h),i=g(a,"fetch",d);if(null!=i&&i instanceof Promise)return void i.then(function(a){e(a)},function(a){f(a)})}a.browserFetch(h).then(function(a){e(a)},function(a){f(a)})})})}}return d.prototype.init=function(){return i(this),e(this),h(this)},d.prototype.forceOffline=function(a){this._forceOffline=a},d.prototype.getCache=function(){return this._cache},d.prototype.isOnline=function(){var a=navigator.onLine;return navigator.network&&navigator.network.connection&&navigator.network.connection.type==Connection.NONE&&(a=!1),a&&!this._isOffline&&!this._forceOffline},d.prototype.register=function(a){a=a||{};var b=new k(a.scope,this);return this._registrations.push(b),Promise.resolve(b)},d.prototype.getRegistration=function(a){var b,c,d=this._registrations.length;for(b=0;b<d;b++)if(c=this._registrations[b],a.match(c.scope))return Promise.resolve(c);return Promise.resolve()},d.prototype.getRegistrations=function(){return Promise.resolve(this._registrations.slice())},d.prototype.getSyncManager=function(){return this._persistenceSyncManager},d.prototype.browserFetch=function(a){if(f()){Object.defineProperty(this,"_browserFetchRequest",{value:a,writable:!0});var b=this;return new Promise(function(c,d){b._browserFetchFunc.call(window,a).then(function(a){c(a)},function(a){d(a)}),b._browserFetchRequest=null})}return fetch(a)},k.prototype.addEventListener=function(a,b){this._eventListeners.push({type:a.toLowerCase(),listener:b})},k.prototype.unregister=function(){return Promise.resolve(j(this._persistenceManager,this))},new d});
//# sourceMappingURL=persistenceManager.js.map