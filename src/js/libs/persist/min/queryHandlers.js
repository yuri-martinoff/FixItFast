/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils"],function(a,b,c){"use strict";function d(a,b){return b=b||function(a){return f(a)},function(d,f){if("GET"==d.method||"HEAD"==d.method){var g,h,j=d.url.split("?"),k={};h="undefined"==typeof URLSearchParams?i(j[1]):new URLSearchParams(j[1]).entries();var l,m,n,o,p;do{l=h.next(),null!=l.value&&(m=l.value[0],n=l.value[1],"q"==m?g=n:"limit"==m?o=n:"offset"==m&&(p=n))}while(!l.done);var q,r,k=b(g);if(null!=f.jsonProcessor&&(q=f.jsonProcessor.shredder,r=f.jsonProcessor.unshredder),null!=q&&null!=r)return e(d,a,k,q,r,p,o).then(function(a){return a?a.clone().text().then(function(b){if(null!=b&&b.length>0)try{var e=JSON.parse(b);return e.links?Promise.resolve(a):(e.links=[{rel:"self",href:d.url}],c.setResponsePayload(a,e).then(function(a){return Promise.resolve(a)}))}catch(a){}}):Promise.resolve()})}return Promise.resolve()}}function e(d,e,f,g,h,i,j){return new Promise(function(m,n){a.getCache().hasMatch(d,{ignoreSearch:!0}).then(function(o){b.openStore(e).then(function(a){if(o)return a.find(f);var b=k(d);return b?a.findByKey(b):Promise.resolve([])}).then(function(b){a.getCache().match(d,{ignoreSearch:!0}).then(function(f){if(f){var k=!1;b&&(i&&i>0&&(k=i<b.length,b=b.slice(i,b.length)),j&&j>0&&(k=j<=b.length,b=b.slice(0,j))),g(f).then(function(a){var d=a[0].resourceType;h([{name:e,data:b,resourceType:d}],f).then(function(a){a.clone().text().then(function(b){if(!(null!=b&&b.length>0))return void m(a);try{var d=JSON.parse(b);null!=d.items&&(j&&(d.limit=parseInt(j,10)),i&&(d.offset=parseInt(i,10)),d.hasMore=k),c.setResponsePayload(a,d).then(function(a){m(a)})}catch(a){}})})})}else if(b&&Object.keys(b).length>0){var n=l(d);n?c.requestToJSON(d).then(function(d){d.url=n,c.requestFromJSON(d).then(function(c){a.getCache().match(c,{ignoreSearch:!0}).then(function(a){if(a){h([{name:e,data:[b],resourceType:"single"}],a).then(function(a){m(a)})}})})}):m()}else m()})}).catch(function(a){n(a)})})})}function f(a){var b={};if(a){var c,d,e=a.split(";"),f={};for(c=0;c<e.length;c++)if(d=e[c].split("=")[0]){var g=e[c].split("=")[1].replace(/^"|'(.*)'|"$/,"$1");f["value."+d]=g}Object.keys(f).length>0&&(b.selector=f)}return b}function g(a,b){return function(c,d){if("GET"==c.method||"HEAD"==c.method){var f,g,i=c.url.split("?"),j=h(i,b);if(null!=d.jsonProcessor&&(f=d.jsonProcessor.shredder,g=d.jsonProcessor.unshredder),null!=f&&null!=g)return e(c,a,j,f,g)}return Promise.resolve()}}function h(a,b){var c={};if(a&&a.length>1){var d,e={};d="undefined"==typeof URLSearchParams?i(a[1]):new URLSearchParams(a[1]).entries();var f,g,h;do{f=d.next(),null!=f.value&&(g=f.value[0],h=f.value[1],b&&-1!=b.indexOf(g)||(e["value."+g]=h))}while(!f.done);Object.keys(e).length>0&&(c.selector=e)}return c}function i(a){var b=[];if(null!=a){"?"===a.charAt(0)&&(a=a.slice(1)),a=a||"";var c,d,e,f=a.split("&");b=f.map(function(a){return e=a.indexOf("="),e>-1?(c=a.slice(0,e),d=a.slice(e+1),d=j(d)):(c=a,d=""),c=j(c),[c,d]})}return{next:function(){var a=b.shift();return{done:void 0===a,value:a}}}}function j(a){return decodeURIComponent(a.replace(/\+/g," "))}function k(a){var b=a.url.split("/");return b.length>1?b[b.length-1]:null}function l(a){if(a.url.split("/").length>1){var b=k(a);return a.url.substring(0,a.url.length-b.length-1)}return null}return{getSimpleQueryHandler:g,getOracleRestQueryHandler:d}});
//# sourceMappingURL=queryHandlers.js.map